<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor de Tickets ¬∑ WhatsApp</title>
  <!-- html5-qrcode para escaneo de c√≥digos de barra con c√°mara -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    /* Variables de color */
    :root {
      --white: #ffffff;
      --red: #e53e3e;
      --red-dark: #9b2c2c;
      --gray: #f7fafc;
      --gray-light: #edf2f7;
      --gray-dark: #4a5568;
      --text: #2d3748;
      --text-light: #718096;
      --accent: #feb2b2;
      --success: #38a169;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    
    *, *::before, *::after { 
      box-sizing: border-box; 
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--gray) 0%, var(--gray-light) 100%);
      color: var(--text);
      padding: 16px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    .container {
      width: 100%;
      max-width: 900px;
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px var(--shadow);
      display: flex;
      flex-direction: column;
      min-height: 600px;
    }
    
    header {
      background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
      color: var(--white);
      padding: 24px;
      text-align: center;
      position: relative;
    }
    
    header::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 10px solid var(--red-dark);
    }
    
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: -0.5px;
    }
    
    .subtitle {
      margin: 8px 0 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 300;
    }
    
    .shortcuts {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    .toggle {
      display: flex;
      margin: 24px 24px 0 24px;
      background: var(--gray-light);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .toggle button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      background: transparent;
      color: var(--gray-dark);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .toggle button[aria-pressed="true"] {
      background: var(--red);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
    }
    
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      gap: 20px;
    }
    
    .stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 200px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
      background: var(--gray-light);
      border-radius: 8px;
      border: 2px dashed var(--border);
    }
    
    .empty-state h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      color: var(--gray-dark);
    }
    
    .ticket-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      position: relative;
    }
    
    .ticket-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border-color: var(--red);
    }
    
    .ticket-card .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--red-dark);
      font-weight: 600;
      font-size: 1.1rem;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .ticket-card .header .badge {
      background: var(--red);
      color: var(--white);
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    
    .ticket-card .fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .field label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--gray-dark);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .field label .required {
      color: var(--red);
      font-size: 0.8rem;
    }
    
    .field input, .field select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: var(--white);
    }
    
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }
    
    .field input.error {
      border-color: #c53030;
      background: #fed7d7;
    }
    
    .field input:disabled {
      background: var(--gray-light);
      color: var(--text-light);
      cursor: not-allowed;
    }
    
    .field input[readonly] {
      background: var(--gray-light);
      color: var(--gray-dark);
      cursor: default;
      border-color: var(--border);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.3;
    }
    
    .field input[readonly]:focus {
      border-color: var(--border);
      box-shadow: none;
    }
    
    /* Campo espec√≠fico para nombre del art√≠culo */
    .nombre-articulo {
      min-height: 2.5rem !important;
      resize: vertical;
      overflow: auto;
      font-size: 0.9rem !important;
      padding: 8px 12px !important;
    }
    
    /* En pantallas grandes, el nombre del art√≠culo ocupa m√°s espacio */
    @media (min-width: 768px) {
      .ticket-card .fields {
        grid-template-columns: 1fr 2fr 1fr 1fr;
      }
      
      .field:nth-child(2) {
        grid-column: span 1;
      }
    }
    
    .remove-btn {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .remove-btn:hover {
      background: #fed7d7;
      color: #c53030;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .actions button {
      flex: 1;
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .actions button.secondary {
      background: var(--gray-light);
      color: var(--gray-dark);
      border: 1px solid var(--border);
    }
    
    .actions button.secondary:hover {
      background: var(--gray-dark);
      color: var(--white);
    }
    
    .actions button.primary {
      background: var(--red);
      color: var(--white);
      box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
    }
    
    .actions button.primary:hover {
      background: var(--red-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
    }
    
    .actions button.danger {
      background: #e53e3e;
      color: var(--white);
      border: 1px solid #c53030;
    }
    
    .actions button.danger:hover {
      background: #c53030;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(197, 48, 48, 0.4);
    }
    
    .actions button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--red-dark);
      color: var(--white);
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      opacity: 0;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: opacity 0.3s ease;
      max-width: 90vw;
      text-align: center;
    }
    
    .toast.show {
      display: block;
      opacity: 1;
    }
    
    .summary {
      background: var(--gray-light);
      padding: 16px;
      border-radius: 8px;
      margin-top: 8px;
      display: none;
    }
    
    .summary.show {
      display: block;
    }
    
    .summary h4 {
      margin: 0 0 8px 0;
      color: var(--gray-dark);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .summary-count {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    /* Estilos para bot√≥n de escaneo de c√≥digo de barras */
    .field-with-button {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .field-with-button .field {
      flex: 1;
    }
    
    .scan-barcode-btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      min-height: 42px;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .scan-barcode-btn:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46a0 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    
    .scan-barcode-btn:active {
      transform: translateY(0);
    }
    
    /* Modal para esc√°ner de c√≥digo de barras */
    .scanner-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    
    .scanner-modal.show {
      display: flex;
    }
    
    .scanner-modal-content {
      background: var(--white);
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .scanner-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border);
    }
    
    .scanner-modal-header h3 {
      margin: 0;
      color: var(--red-dark);
      font-size: 1.3rem;
    }
    
    .scanner-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-light);
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .scanner-modal-close:hover {
      background: var(--gray-light);
      color: var(--red);
    }
    
    .scanner-container {
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
      position: relative;
    }
    
    #reader {
      width: 100%;
      border: none;
    }
    
    .scanner-info {
      background: var(--gray-light);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      border-left: 4px solid #667eea;
    }
    
    .scanner-info p {
      margin: 4px 0;
      font-size: 0.9rem;
      color: var(--gray-dark);
    }
    
    .scanner-result {
      background: var(--success);
      color: var(--white);
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .scanner-result.show {
      display: flex;
    }
    
    .scanner-result strong {
      font-size: 1.1rem;
    }
    
    .scanner-modal-actions {
      display: flex;
      gap: 12px;
    }
    
    .scanner-modal-actions button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-cancel {
      background: var(--gray-light);
      color: var(--gray-dark);
      border: 1px solid var(--border);
    }
    
    .btn-cancel:hover {
      background: var(--gray-dark);
      color: var(--white);
    }
    
    /* Responsive para bot√≥n de escaneo */
    @media (max-width: 768px) {
      .field-with-button {
        flex-direction: column;
        gap: 12px;
      }
      
      .scan-barcode-btn {
        width: 100%;
        justify-content: center;
      }
      
      .scanner-modal-content {
        padding: 20px;
        margin: 0 10px;
      }
      
      .scanner-modal-header h3 {
        font-size: 1.1rem;
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      
      .container {
        border-radius: 8px;
        min-height: auto;
      }
      
      header {
        padding: 20px 16px;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      .content {
        padding: 16px;
        gap: 16px;
      }
      
      .toggle {
        margin: 16px 16px 0 16px;
      }
      
      .toggle button {
        padding: 10px 12px;
        font-size: 0.9rem;
      }
      
      .ticket-card {
        padding: 16px;
      }
      
      .ticket-card .fields {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      /* En m√≥viles, el nombre del art√≠culo ocupa toda la fila */
      .field:has(.nombre-articulo) {
        grid-column: 1 / -1;
      }
      
      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      
      .actions button {
        padding: 12px 8px;
        font-size: 0.9rem;
      }
      
      /* El bot√≥n de WhatsApp ocupa toda la fila inferior */
      .actions button:last-child {
        grid-column: 1 / -1;
      }
    }
    
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.3rem;
      }
      
      .content {
        padding: 12px;
      }
      
      .toggle {
        margin: 12px 12px 0 12px;
      }
      
      .ticket-card {
        padding: 12px;
      }
      
      .ticket-card .header {
        font-size: 1rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .actions button {
        padding: 10px 6px;
        font-size: 0.85rem;
      }
      
      .shortcuts {
        display: none;
      }
      
      .ticket-card .fields {
        grid-template-columns: 1fr !important;
      }
      
      .scanner-modal-content {
        padding: 16px;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .scanner-modal-header h3 {
        font-size: 1rem;
      }
      
      .scanner-modal-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestor de Tickets</h1>
      <p class="subtitle">Sistema profesional para gesti√≥n de impresiones</p>
      <p class="shortcuts">Ctrl+Enter: Agregar | Ctrl+Shift+Enter: Enviar | Ctrl+Shift+Del: Limpiar</p>
    </header>
    
    <div class="toggle" role="group" aria-label="Seleccionar tipo de ticket">
      <button id="btnImp" aria-pressed="true" data-mode="impresion">Impresi√≥n</button>
      <button id="btnReimp" aria-pressed="false" data-mode="reimpresion">Re-impresi√≥n</button>
    </div>
    
    <div class="content">
      <div class="stack" id="forms">
        <div class="empty-state">
          <h3>No hay tickets creados</h3>
          <p>Haz clic en "Agregar ticket" para comenzar</p>
        </div>
      </div>
      
      <div class="summary" id="summary">
        <h4>Resumen</h4>
        <div class="summary-count" id="summaryCount">0 tickets creados</div>
        <div style="margin-top: 8px;">
          <small id="dbStatus" style="color: #718096;">Base de datos: No cargada</small>
          <button id="reloadDB" style="display: none; margin-left: 8px; padding: 2px 6px; font-size: 0.7rem; background: #e53e3e; color: white; border: none; border-radius: 3px; cursor: pointer;">Recargar BD</button>
        </div>
      </div>
      
      <div class="actions">
        <button id="addBtn" class="secondary">+ Agregar ticket</button>
        <button id="clearBtn" class="danger" style="display: none;">x Limpiar todo</button>
        <button id="copyBtn" class="secondary" style="display: none;">Copiar mensaje</button>
        <button id="sendBtn" class="primary">Enviar por WhatsApp</button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <!-- Modal para esc√°ner de c√≥digo de barras -->
  <div class="scanner-modal" id="scannerModal">
    <div class="scanner-modal-content">
      <div class="scanner-modal-header">
        <h3>üì∑ Escanear C√≥digo de Barras</h3>
        <button class="scanner-modal-close" id="closeScannerModal" aria-label="Cerrar">&times;</button>
      </div>
      <div class="scanner-info">
        <p>üìç Apunta la c√°mara al c√≥digo de barras</p>
        <p>El escaneo es autom√°tico cuando detecte el c√≥digo</p>
      </div>
      <div class="scanner-result" id="scannerResult">
        <span>‚úÖ</span>
        <div>
          <strong>C√≥digo detectado:</strong>
          <span id="scannedCode"></span>
        </div>
      </div>
      <div class="scanner-container">
        <div id="reader"></div>
      </div>
      <div class="scanner-modal-actions">
        <button class="btn-cancel" id="cancelScanner">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tplImp">
    <div class="ticket-card" data-kind="impresion">
      <div class="header">
        <span>Ticket de Impresi√≥n <span class="badge" id="ticketNumber"></span></span>
        <button class="remove-btn" data-action="remove">x Eliminar</button>
      </div>
      <div class="fields">
        <div class="field">
          <label>C√≥digo de Art√≠culo <span class="required">*</span></label>
          <input type="text" class="codigo" placeholder="Solo n√∫meros: 123456" required autocomplete="off" pattern="[0-9]*" inputmode="numeric">
        </div>
        <div class="field">
          <label>Nombre del Art√≠culo</label>
          <input type="text" class="nombre-articulo" placeholder="Se cargar√° autom√°ticamente..." readonly style="background: #f7fafc; color: #4a5568;">
        </div>
        <div class="field">
          <label>Tipo de Art√≠culo</label>
          <select class="tipo">
            <option value="Nuevo/Usado">Nuevo/Usado</option>
            <option value="Reparaci√≥n">Reparaci√≥n</option>
          </select>
        </div>
        <div class="field">
          <label>Cantidad <span class="required">*</span></label>
          <input type="number" class="cantidad" min="1" max="999" value="1" required>
        </div>
      </div>
    </div>
  </template>
  
  <template id="tplReimp">
    <div class="ticket-card" data-kind="reimpresion">
      <div class="header">
        <span>Ticket de Re-impresi√≥n <span class="badge" id="ticketNumber"></span></span>
        <button class="remove-btn" data-action="remove">x Eliminar</button>
      </div>
      <div class="fields">
        <div class="field-with-button">
          <div class="field">
            <label>ID de Art√≠culo <span class="required">*</span></label>
            <input type="text" class="idart" placeholder="Solo n√∫meros: 987654" required autocomplete="off" pattern="[0-9]*" inputmode="numeric">
          </div>
          <button class="scan-barcode-btn" data-action="scan-barcode" title="Escanear con c√°mara">
            <span>üì∑</span>
            <span class="btn-text">Escanear</span>
          </button>
        </div>
        <div class="field">
          <label>Motivo de Re-impresi√≥n</label>
          <select class="motivo">
            <option value="Etiqueta da√±ada">Etiqueta da√±ada</option>
            <option value="Error en datos">Error en datos</option>
            <option value="P√©rdida de etiqueta">P√©rdida de etiqueta</option>
            <option value="Solicitud cliente">Solicitud cliente</option>
          </select>
        </div>
        <div class="field">
          <label>Cantidad</label>
          <input type="number" class="cantidad" disabled value="1" readonly>
        </div>
      </div>
    </div>
  </template>

  <script>
    // Elementos DOM
    const forms = document.getElementById('forms');
    const btnImp = document.getElementById('btnImp');
    const btnReimp = document.getElementById('btnReimp');
    const addBtn = document.getElementById('addBtn');
    const sendBtn = document.getElementById('sendBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const toast = document.getElementById('toast');
    const summary = document.getElementById('summary');
    const summaryCount = document.getElementById('summaryCount');
    const dbStatus = document.getElementById('dbStatus');
    const reloadDB = document.getElementById('reloadDB');
    const tplImp = document.getElementById('tplImp');
    const tplReimp = document.getElementById('tplReimp');
    
    // Variables globales
    let mode = 'impresion';
    let ticketCounter = 0;
    
    // Base de datos de art√≠culos
    let articulosDB = new Map();
    let isLoadingArticulos = false;
    let articulosLoaded = false;

    // Cargar base de datos de art√≠culos desde Google Sheets
    async function loadArticulosDB() {
      if (articulosLoaded || isLoadingArticulos) return;
      
      isLoadingArticulos = true;
      toastMsg('Cargando base de datos de art√≠culos...', 1000);
      
      // Actualizar estado en la interfaz
      dbStatus.textContent = 'Base de datos: Cargando...';
      dbStatus.style.color = '#718096';
      reloadDB.style.display = 'none';
      
      try {
        // URL de tu Google Sheets en formato CSV
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/1M8blOHHzoaBSacXtyIEfouvacWedb2m2/export?format=csv&gid=3478202';
        
        const response = await fetch(sheetUrl);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}. Verifica que la hoja sea p√∫blica.`);
        }
        
        const csvText = await response.text();
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('La hoja est√° vac√≠a o no se pudo leer');
        }
        
        // Parsear CSV
        const lines = csvText.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          throw new Error('La hoja debe tener al menos una fila de encabezados y una de datos');
        }
        
        // Parsear encabezados de forma m√°s robusta
        const rawHeaders = lines[0].split(',');
        const headers = rawHeaders.map(h => h.trim().replace(/"/g, ''));
        console.log('Encabezados EXACTOS encontrados:', headers);
        
        // Encontrar columnas de c√≥digo y nombre - B√öSQUEDA EXACTA
        let codigoIndex = -1;
        let nombreIndex = -1;
        
        // Buscar c√≥digo (primera columna generalmente)
        for (let i = 0; i < headers.length; i++) {
          const header = headers[i].toLowerCase();
          if (header.includes('codigo') || header.includes('c√≥digo') || header.includes('id') || header.includes('sku')) {
            codigoIndex = i;
            break;
          }
        }
        
        // Buscar "Nombre del producto" EXACTO
        for (let i = 0; i < headers.length; i++) {
          const header = headers[i];
          console.log(`Comparando header ${i}: "${header}"`);
          if (header === 'Nombre del producto' || 
              header === 'NOMBRE DEL PRODUCTO' ||
              header.toLowerCase() === 'nombre del producto') {
            nombreIndex = i;
            console.log(`¬°ENCONTRADO! √çndice nombre: ${i}`);
            break;
          }
        }
        
        // Si no encuentra "Nombre del producto", buscar alternativas
        if (nombreIndex === -1) {
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i].toLowerCase();
            if (header.includes('nombre') || header.includes('descripcion') || header.includes('producto')) {
              nombreIndex = i;
              console.log(`Usando header alternativo: ${headers[i]} en √≠ndice ${i}`);
              break;
            }
          }
        }
        
        console.log(`RESULTADO: C√≥digo √≠ndice: ${codigoIndex}, Nombre √≠ndice: ${nombreIndex}`);
        
        if (codigoIndex === -1 || nombreIndex === -1) {
          console.error('Columnas disponibles:', headers);
          console.error(`No se encontr√≥ c√≥digo: ${codigoIndex === -1}, No se encontr√≥ nombre: ${nombreIndex === -1}`);
          throw new Error(`COLUMNAS NO ENCONTRADAS:
                          - Columnas disponibles: ${headers.join(' | ')}
                          - Buscando columna de c√≥digo: ${codigoIndex === -1 ? 'NO ENCONTRADA' : 'ENCONTRADA'}
                          - Buscando "Nombre del producto": ${nombreIndex === -1 ? 'NO ENCONTRADA' : 'ENCONTRADA'}`);
        }
        
        // Procesar datos - MEJORADO para manejar comillas
        let articulosCargados = 0;
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim()) {
            // Parsear CSV m√°s robusto
            const cols = [];
            let current = '';
            let inQuotes = false;
            const line = lines[i];
            
            for (let j = 0; j < line.length; j++) {
              const char = line[j];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                cols.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            cols.push(current.trim()); // √öltimo elemento
            
            const codigo = cols[codigoIndex]?.toString().trim().replace(/"/g, '');
            const nombre = cols[nombreIndex]?.toString().trim().replace(/"/g, '');
            
            if (i <= 3) { // Solo mostrar las primeras 3 filas para debug
              console.log(`Fila ${i}: C√≥digo="${codigo}", Nombre="${nombre}"`);
            }
            
            if (codigo && nombre && codigo !== '' && nombre !== '') {
              articulosDB.set(codigo, nombre);
              articulosCargados++;
            }
          }
        }
        
        if (articulosCargados === 0) {
          throw new Error('No se encontraron art√≠culos v√°lidos en la hoja');
        }
        
        articulosLoaded = true;
        toastMsg(`Base de datos cargada: ${articulosCargados} art√≠culos`, 2000, 'success');
        console.log(`=== RESUMEN DE CARGA ===`);
        console.log(`Art√≠culos cargados: ${articulosCargados}`);
        console.log(`Columna c√≥digo (√≠ndice ${codigoIndex}): ${headers[codigoIndex]}`);
        console.log(`Columna nombre (√≠ndice ${nombreIndex}): ${headers[nombreIndex]}`);
        console.log('Primeros 5 art√≠culos cargados:');
        Array.from(articulosDB.entries()).slice(0, 5).forEach(([codigo, nombre]) => {
          console.log(`  ${codigo} -> ${nombre}`);
        });
        console.log(`========================`);
        
        // Actualizar estado en la interfaz
        dbStatus.textContent = `Base de datos: ${articulosCargados} art√≠culos cargados`;
        dbStatus.style.color = '#38a169';
        reloadDB.style.display = 'none';
        
      } catch (error) {
        console.error('Error cargando art√≠culos:', error);
        
        let errorMessage = 'Error al cargar base de datos. ';
        if (error.message.includes('403') || error.message.includes('401')) {
          errorMessage += 'Verifica que la hoja de Google Sheets sea p√∫blica.';
        } else if (error.message.includes('CORS')) {
          errorMessage += 'Problema de CORS. Verifica la configuraci√≥n de la hoja.';
        } else {
          errorMessage += error.message;
        }
        
        toastMsg(errorMessage, 5000);
        articulosLoaded = false;
        
        // Actualizar estado en la interfaz
        dbStatus.textContent = 'Base de datos: Error al cargar';
        dbStatus.style.color = '#e53e3e';
        reloadDB.style.display = 'inline-block';
      }
      
      isLoadingArticulos = false;
    }

    // Funci√≥n para recargar la base de datos manualmente
    function reloadArticulosDB() {
      articulosLoaded = false;
      articulosDB.clear();
      loadArticulosDB();
    }

    // Buscar nombre de art√≠culo por c√≥digo
    function getNombreArticulo(codigo) {
      if (!codigo || !articulosLoaded) {
        console.log('Base de datos no cargada o c√≥digo vac√≠o');
        return '';
      }
      
      const codigoStr = codigo.toString().trim();
      console.log(`Buscando c√≥digo: "${codigoStr}"`);
      console.log(`Base de datos tiene ${articulosDB.size} art√≠culos`);
      
      // B√∫squeda exacta
      if (articulosDB.has(codigoStr)) {
        const nombre = articulosDB.get(codigoStr);
        console.log(`ENCONTRADO exacto: ${codigoStr} -> ${nombre}`);
        return nombre;
      }
      
      // B√∫squeda flexible (sin ceros a la izquierda, etc.)
      const codigoNum = parseInt(codigoStr, 10);
      if (!isNaN(codigoNum)) {
        for (let [key, value] of articulosDB) {
          if (parseInt(key, 10) === codigoNum) {
            console.log(`ENCONTRADO flexible: ${codigoStr} -> ${value} (clave: ${key})`);
            return value;
          }
        }
      }
      
      // Mostrar algunos ejemplos de la base de datos
      const ejemplos = Array.from(articulosDB.entries()).slice(0, 3);
      console.log(`NO ENCONTRADO. Ejemplos en BD:`, ejemplos);
      
      return 'Desconocido';
    }

    // Funciones utilitarias
    function toastMsg(msg, duration = 3000, type = 'info') {
      toast.textContent = msg;
      toast.className = `toast show ${type}`;
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.style.display = 'none', 300);
      }, duration);
    }

    function updateSummary() {
      const count = forms.children.length - (forms.querySelector('.empty-state') ? 1 : 0);
      if (count > 0) {
        summary.classList.add('show');
        summaryCount.textContent = `${count} ticket${count !== 1 ? 's' : ''} creado${count !== 1 ? 's' : ''}`;
        forms.querySelector('.empty-state')?.remove();
        copyBtn.style.display = 'inline-block';
        clearBtn.style.display = 'inline-block';
      } else {
        summary.classList.remove('show');
        copyBtn.style.display = 'none';
        clearBtn.style.display = 'none';
        if (!forms.querySelector('.empty-state')) {
          forms.innerHTML = `
            <div class="empty-state">
              <h3>No hay tickets creados</h3>
              <p>Haz clic en "Agregar ticket" para comenzar</p>
            </div>
          `;
        }
      }
    }

    function clearAllTickets() {
      const tickets = Array.from(forms.children).filter(card => card.classList.contains('ticket-card'));
      
      if (tickets.length === 0) {
        toastMsg('No hay tickets para eliminar', 2000, 'error');
        return;
      }
      
      // Confirmaci√≥n antes de eliminar todo
      const confirmMessage = `¬øEst√°s seguro de que quieres eliminar todos los ${tickets.length} tickets?\n\nEsta acci√≥n no se puede deshacer.`;
      
      if (window.confirm(confirmMessage)) {
        // Eliminar todos los tickets
        tickets.forEach(ticket => ticket.remove());
        
        // Resetear contador
        ticketCounter = 0;
        
        // Actualizar interfaz
        updateSummary();
        
        toastMsg(`Se eliminaron ${tickets.length} tickets correctamente`, 2000, 'success');
      }
    }

    function validateNumericInput(input) {
      // Permitir solo n√∫meros enteros
      input.value = input.value.replace(/[^0-9]/g, '');
      
      // Si es un campo de c√≥digo, buscar el nombre del art√≠culo
      if (input.classList.contains('codigo')) {
        const nombreField = input.closest('.ticket-card').querySelector('.nombre-articulo');
        if (nombreField) {
          const codigo = input.value.trim();
          if (codigo) {
            if (articulosLoaded) {
              const nombre = getNombreArticulo(codigo);
              nombreField.value = nombre;
              
              // Cambiar estilo seg√∫n si se encontr√≥ o no
              if (nombre === 'Desconocido') {
                nombreField.style.color = '#e53e3e';
                nombreField.style.fontStyle = 'italic';
              } else {
                nombreField.style.color = '#38a169';
                nombreField.style.fontStyle = 'normal';
              }
            } else {
              nombreField.value = 'Cargando base de datos...';
              nombreField.style.color = '#718096';
              nombreField.style.fontStyle = 'italic';
              
              // Intentar cargar la base de datos si no est√° cargada
              loadArticulosDB().then(() => {
                if (articulosLoaded && input.value.trim()) {
                  const nombre = getNombreArticulo(input.value.trim());
                  nombreField.value = nombre;
                  
                  if (nombre === 'Desconocido') {
                    nombreField.style.color = '#e53e3e';
                    nombreField.style.fontStyle = 'italic';
                  } else {
                    nombreField.style.color = '#38a169';
                    nombreField.style.fontStyle = 'normal';
                  }
                }
              });
            }
          } else {
            nombreField.value = '';
            nombreField.style.color = '#4a5568';
            nombreField.style.fontStyle = 'normal';
          }
        }
      }
      
      // Validar que no est√© vac√≠o para campos requeridos
      if (input.hasAttribute('required')) {
        input.classList.remove('error');
        if (input.value.trim()) {
          input.style.borderColor = '#38a169';
        }
      }
    }

    function copyMessageToClipboard() {
      const tickets = Array.from(forms.children).filter(card => card.classList.contains('ticket-card'));
      if (tickets.length === 0) {
        toastMsg('No hay tickets para copiar', 2000, 'error');
        return;
      }
      
      if (!validateAllFields()) {
        toastMsg('Por favor, completa todos los campos requeridos', 3000, 'error');
        return;
      }
      
      const message = buildProfessionalMessage();
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(message).then(() => {
          toastMsg('Mensaje copiado al portapapeles', 2000, 'success');
        }).catch(err => {
          console.error('Error al copiar:', err);
          fallbackCopyTextToClipboard(message);
        });
      } else {
        fallbackCopyTextToClipboard(message);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        toastMsg('Mensaje copiado al portapapeles', 2000, 'success');
      } catch (err) {
        toastMsg('No se pudo copiar el mensaje', 2000, 'error');
      }
      
      document.body.removeChild(textArea);
    }

    function setMode(m) {
      mode = m;
      btnImp.setAttribute('aria-pressed', m === 'impresion');
      btnReimp.setAttribute('aria-pressed', m === 'reimpresion');
      
      // Cargar base de datos si se selecciona impresi√≥n
      if (m === 'impresion' && !articulosLoaded && !isLoadingArticulos) {
        loadArticulosDB();
      }
    }

    function addTicket() {
      const tpl = mode === 'impresion' ? tplImp : tplReimp;
      const clone = tpl.content.firstElementChild.cloneNode(true);
      
      ticketCounter++;
      const badge = clone.querySelector('#ticketNumber');
      badge.textContent = `#${ticketCounter}`;
      badge.id = `ticket-${ticketCounter}`;
      
      forms.appendChild(clone);
      updateSummary();
      
      // Cargar base de datos si es ticket de impresi√≥n y no est√° cargada
      if (mode === 'impresion' && !articulosLoaded && !isLoadingArticulos) {
        loadArticulosDB();
      }
      
      // Enfocar el primer campo del nuevo ticket
      const firstInput = clone.querySelector('input[required]');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
      }
      
      toastMsg(`Ticket #${ticketCounter} agregado correctamente`, 2000, 'success');
    }

    function removeTicket(card) {
      const ticketNumber = card.querySelector('.badge').textContent;
      card.remove();
      updateSummary();
      toastMsg(`Ticket ${ticketNumber} eliminado`, 2000);
    }

    function buildProfessionalMessage() {
      const cards = Array.from(forms.children).filter(card => card.classList.contains('ticket-card'));
      if (!cards.length) return '';
      
      const currentDate = new Date().toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      let message = `SOLICITUD DE TICKETS\n`;
      message += `Fecha: ${currentDate}\n`;
      message += `Total de tickets: ${cards.length}\n\n`;
      message += `=====================================\n\n`;
      
      cards.forEach((card, index) => {
        const ticketNum = index + 1;
        
        if (card.dataset.kind === 'impresion') {
          const codigo = card.querySelector('.codigo').value.trim();
          const nombre = card.querySelector('.nombre-articulo').value.trim();
          const tipo = card.querySelector('.tipo').value;
          const cantidad = card.querySelector('.cantidad').value;
          
          message += `TICKET #${ticketNum} - IMPRESION\n`;
          message += `- Codigo: ${codigo}\n`;
          if (nombre && nombre !== 'Cargando base de datos...' && nombre !== 'Se cargar√° autom√°ticamente...') {
            message += `- Nombre: ${nombre}\n`;
          }
          message += `- Tipo: ${tipo}\n`;
          message += `- Cantidad: ${cantidad} unidad${cantidad > 1 ? 'es' : ''}\n\n`;
        } else {
          const id = card.querySelector('.idart').value.trim();
          const motivo = card.querySelector('.motivo').value;
          
          message += `TICKET #${ticketNum} - RE-IMPRESION\n`;
          message += `- ID Articulo: ${id}\n`;
          message += `- Motivo: ${motivo}\n`;
          message += `- Cantidad: 1 unidad\n\n`;
        }
      });
      
      message += `=====================================\n`;
      message += `Procesamiento requerido\n`;
      message += `Enviado desde Gestor de Tickets`;
      
      return message;
    }

    function validateAllFields() {
      let isValid = true;
      const cards = Array.from(forms.children).filter(card => card.classList.contains('ticket-card'));
      
      cards.forEach(card => {
        card.querySelectorAll('input[required]').forEach(input => {
          input.classList.remove('error');
          if (!input.value.trim()) {
            input.classList.add('error');
            isValid = false;
          }
        });
      });
      
      return isValid;
    }

    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function sendToWhatsApp() {
      console.log('Bot√≥n de WhatsApp clickeado'); // Debug
      
      // Verificar que hay tickets
      const tickets = Array.from(forms.children).filter(card => card.classList.contains('ticket-card'));
      if (tickets.length === 0) {
        toastMsg('No hay tickets para enviar', 2000, 'error');
        return;
      }
      
      // Validar campos
      if (!validateAllFields()) {
        toastMsg('Por favor, completa todos los campos requeridos', 3000, 'error');
        return;
      }
      
      // Construir mensaje
      const message = buildProfessionalMessage();
      console.log('Mensaje construido:', message); // Debug
      
      if (!message) {
        toastMsg('Error al construir el mensaje', 2000, 'error');
        return;
      }
      
      // Crear URL de WhatsApp - versi√≥n simplificada y m√°s compatible
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      console.log('URL de WhatsApp:', whatsappUrl); // Debug
      
      // Intentar abrir WhatsApp
      try {
        // M√©todo m√°s directo y compatible
        if (isMobileDevice()) {
          // En m√≥viles, intenta abrir la app directamente
          window.location.href = whatsappUrl;
        } else {
          // En escritorio, abre en nueva pesta√±a
          const newWindow = window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
          if (!newWindow) {
            // Si el popup fue bloqueado, intenta con location
            window.location.href = whatsappUrl;
          }
        }
        toastMsg('Abriendo WhatsApp...', 2000, 'success');
      } catch (error) {
        console.error('Error al abrir WhatsApp:', error);
        toastMsg('Error al abrir WhatsApp. Intenta copiar el mensaje manualmente.', 4000, 'error');
        
        // Como √∫ltima opci√≥n, copiar al portapapeles
        if (navigator.clipboard) {
          navigator.clipboard.writeText(message).then(() => {
            toastMsg('Mensaje copiado al portapapeles', 3000, 'success');
          });
        }
      }
    }

    // ==========================================
    // FUNCIONALIDAD DE ESC√ÅNER DE C√ìDIGO DE BARRAS
    // ==========================================
    
    let html5QrcodeScanner = null;
    let currentInputTarget = null;
    const scannerModal = document.getElementById('scannerModal');
    const closeScannerModal = document.getElementById('closeScannerModal');
    const cancelScanner = document.getElementById('cancelScanner');
    const scannerResult = document.getElementById('scannerResult');
    const scannedCode = document.getElementById('scannedCode');

    // Iniciar esc√°ner de c√≥digo de barras
    function startBarcodeScanner(inputElement) {
      currentInputTarget = inputElement;
      
      // Mostrar modal
      scannerModal.classList.add('show');
      scannerResult.classList.remove('show');
      
      // Configurar y iniciar esc√°ner
      if (!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("reader");
      }
      
      // Configuraci√≥n del esc√°ner
      const config = {
        fps: 10,
        qrbox: { width: 250, height: 100 },
        aspectRatio: 1.777778,
        formatsToSupport: [
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E
        ]
      };
      
      // Iniciar c√°mara
      html5QrcodeScanner.start(
        { facingMode: "environment" }, // C√°mara trasera
        config,
        onScanSuccess,
        onScanError
      ).catch(err => {
        console.error('Error iniciando esc√°ner:', err);
        toastMsg('Error al acceder a la c√°mara. Verifica los permisos.', 3000, 'error');
        stopBarcodeScanner();
      });
      
      toastMsg('Esc√°ner activado. Apunta al c√≥digo de barras.', 2000, 'success');
    }

    // Callback cuando se escanea exitosamente
    function onScanSuccess(decodedText, decodedResult) {
      console.log('C√≥digo escaneado:', decodedText);
      
      // Validar que sea num√©rico (puedes ajustar esto seg√∫n necesites)
      const cleanedCode = decodedText.replace(/[^0-9]/g, '');
      
      if (cleanedCode) {
        // Mostrar resultado
        scannedCode.textContent = cleanedCode;
        scannerResult.classList.add('show');
        
        // Asignar al campo de entrada
        if (currentInputTarget) {
          currentInputTarget.value = cleanedCode;
          
          // Disparar evento input para activar validaciones
          const event = new Event('input', { bubbles: true });
          currentInputTarget.dispatchEvent(event);
        }
        
        // Detener esc√°ner y cerrar despu√©s de 1.5 segundos
        setTimeout(() => {
          stopBarcodeScanner();
          toastMsg(`C√≥digo ${cleanedCode} escaneado correctamente`, 2000, 'success');
        }, 1500);
      } else {
        toastMsg('C√≥digo no v√°lido. Intenta de nuevo.', 2000, 'error');
      }
    }

    // Callback de errores (silencioso, solo para debugging)
    function onScanError(errorMessage) {
      // No mostrar errores continuos, solo en consola
      // console.log('Escaneando...', errorMessage);
    }

    // Detener esc√°ner
    function stopBarcodeScanner() {
      if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
        html5QrcodeScanner.stop().then(() => {
          scannerModal.classList.remove('show');
          currentInputTarget = null;
          scannerResult.classList.remove('show');
        }).catch(err => {
          console.error('Error deteniendo esc√°ner:', err);
          scannerModal.classList.remove('show');
        });
      } else {
        scannerModal.classList.remove('show');
      }
    }

    // Event Listeners para esc√°ner
    closeScannerModal.addEventListener('click', stopBarcodeScanner);
    cancelScanner.addEventListener('click', stopBarcodeScanner);

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && scannerModal.classList.contains('show')) {
        stopBarcodeScanner();
      }
    });

    // Event Listeners
    forms.addEventListener('click', (e) => {
      // Manejar bot√≥n de escanear c√≥digo de barras
      if (e.target.closest('[data-action="scan-barcode"]')) {
        e.preventDefault();
        const btn = e.target.closest('[data-action="scan-barcode"]');
        const card = btn.closest('.ticket-card');
        const idInput = card.querySelector('.idart');
        
        if (idInput) {
          startBarcodeScanner(idInput);
        }
        return;
      }
      
      // Manejar bot√≥n de eliminar ticket
      if (e.target.dataset.action === 'remove' || e.target.closest('[data-action="remove"]')) {
        const card = e.target.closest('.ticket-card');
        if (card) removeTicket(card);
      }
    });

    // Validaci√≥n en tiempo real
    forms.addEventListener('input', (e) => {
      // Validaci√≥n para campos num√©ricos (c√≥digo, ID, cantidad)
      if (e.target.classList.contains('codigo') || 
          e.target.classList.contains('idart') || 
          e.target.classList.contains('cantidad')) {
        validateNumericInput(e.target);
      }
      
      // Validaci√≥n general para campos requeridos
      if (e.target.hasAttribute('required')) {
        e.target.classList.remove('error');
        if (e.target.value.trim()) {
          e.target.style.borderColor = '#38a169';
        }
      }
    });

    // Prevenir pegado de texto no num√©rico
    forms.addEventListener('paste', (e) => {
      if (e.target.classList.contains('codigo') || 
          e.target.classList.contains('idart') || 
          e.target.classList.contains('cantidad')) {
        
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const numericValue = paste.replace(/[^0-9]/g, '');
        e.target.value = numericValue;
        validateNumericInput(e.target);
      }
    });

    btnImp.addEventListener('click', () => setMode('impresion'));
    btnReimp.addEventListener('click', () => setMode('reimpresion'));
    addBtn.addEventListener('click', addTicket);
    sendBtn.addEventListener('click', sendToWhatsApp);
    copyBtn.addEventListener('click', copyMessageToClipboard);
    reloadDB.addEventListener('click', reloadArticulosDB);
    clearBtn.addEventListener('click', clearAllTickets);

    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        addTicket();
      }
      if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        sendToWhatsApp();
      }
      if (e.ctrlKey && e.shiftKey && e.key === 'Delete') {
        e.preventDefault();
        console.log('Atajo de teclado para limpiar activado'); // Debug
        clearAllTickets();
      }
    });

    // Inicializaci√≥n
    updateSummary();
    
    // Mostrar estado inicial de la base de datos
    dbStatus.textContent = 'Base de datos: Cargando...';
    dbStatus.style.color = '#718096';
    
    // Cargar base de datos de art√≠culos al inicio
    loadArticulosDB();
    
    // Agregar primer ticket autom√°ticamente
    setTimeout(() => {
      addTicket();
    }, 500);
  </script>
</body>
</html>
